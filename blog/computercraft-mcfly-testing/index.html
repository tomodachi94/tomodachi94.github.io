<!doctype html><html lang=en-us><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Unit testing with ComputerCraft, McFly, and CraftOS-PC | Tomodachi94's Musings</title><meta name=title content="Unit testing with ComputerCraft, McFly, and CraftOS-PC"><meta name=description content="Unit testing is awesome.
It helps you catch bugs early by ensuring all of the components of your program work as expected.
Note: This guide is targeted towards experts who have advanced knowledge of ComputerCraft and know a few things about unit tests.
Experience with unit tests in another language is helpful too, but isn&rsquo;t required.
CC: Tweaked contains a little-known unit testing framework called McFly, which describes itself as &ldquo;a very basic test framework for ComputerCraft&rdquo; drawing inspiration from the Busted framework for Lua.
This post will function as an introduction to McFly, in the process providing instructions for running the tests inside of the CraftOS-PC emulator, suitable for running in a continuous integration pipeline."><meta name=keywords content="ComputerCraft,McFly,CraftOS-PC,Unit testing,Lua,Continuous integration,"><meta property="og:url" content="https://tomodachi94.github.io/blog/computercraft-mcfly-testing/"><meta property="og:site_name" content="Tomodachi94's Musings"><meta property="og:title" content="Unit testing with ComputerCraft, McFly, and CraftOS-PC"><meta property="og:description" content="Unit testing is awesome. It helps you catch bugs early by ensuring all of the components of your program work as expected.
Note: This guide is targeted towards experts who have advanced knowledge of ComputerCraft and know a few things about unit tests. Experience with unit tests in another language is helpful too, but isn’t required.
CC: Tweaked contains a little-known unit testing framework called McFly, which describes itself as “a very basic test framework for ComputerCraft” drawing inspiration from the Busted framework for Lua. This post will function as an introduction to McFly, in the process providing instructions for running the tests inside of the CraftOS-PC emulator, suitable for running in a continuous integration pipeline."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2025-02-09T00:00:00+00:00"><meta property="article:modified_time" content="2025-02-09T00:00:00+00:00"><meta property="article:tag" content="ComputerCraft"><meta property="article:tag" content="McFly"><meta property="article:tag" content="CraftOS-PC"><meta property="article:tag" content="Unit Testing"><meta property="article:tag" content="Lua"><meta property="article:tag" content="Continuous Integration"><meta name=twitter:card content="summary"><meta name=twitter:title content="Unit testing with ComputerCraft, McFly, and CraftOS-PC"><meta name=twitter:description content="Unit testing is awesome. It helps you catch bugs early by ensuring all of the components of your program work as expected.
Note: This guide is targeted towards experts who have advanced knowledge of ComputerCraft and know a few things about unit tests. Experience with unit tests in another language is helpful too, but isn’t required.
CC: Tweaked contains a little-known unit testing framework called McFly, which describes itself as “a very basic test framework for ComputerCraft” drawing inspiration from the Busted framework for Lua. This post will function as an introduction to McFly, in the process providing instructions for running the tests inside of the CraftOS-PC emulator, suitable for running in a continuous integration pipeline."><meta itemprop=name content="Unit testing with ComputerCraft, McFly, and CraftOS-PC"><meta itemprop=description content="Unit testing is awesome. It helps you catch bugs early by ensuring all of the components of your program work as expected.
Note: This guide is targeted towards experts who have advanced knowledge of ComputerCraft and know a few things about unit tests. Experience with unit tests in another language is helpful too, but isn’t required.
CC: Tweaked contains a little-known unit testing framework called McFly, which describes itself as “a very basic test framework for ComputerCraft” drawing inspiration from the Busted framework for Lua. This post will function as an introduction to McFly, in the process providing instructions for running the tests inside of the CraftOS-PC emulator, suitable for running in a continuous integration pipeline."><meta itemprop=datePublished content="2025-02-09T00:00:00+00:00"><meta itemprop=dateModified content="2025-02-09T00:00:00+00:00"><meta itemprop=wordCount content="785"><meta itemprop=keywords content="ComputerCraft,McFly,CraftOS-PC,Unit Testing,Lua,Continuous Integration"><meta name=referrer content="no-referrer-when-downgrade"><style>:root{--width:720px;--font-main:Verdana, sans-serif;--font-secondary:Verdana, sans-serif;--font-scale:1em;--background-color:#fff;--heading-color:#222;--text-color:#444;--link-color:#3273dc;--visited-color:#8b6fcb;--blockquote-color:#222}@media(prefers-color-scheme:dark){:root{--background-color:#01242e;--heading-color:#eee;--text-color:#ddd;--link-color:#8cc2dd;--visited-color:#8b6fcb;--blockquote-color:#ccc}}body{font-family:var(--font-secondary);font-size:var(--font-scale);margin:auto;padding:20px;max-width:var(--width);text-align:left;background-color:var(--background-color);word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:var(--text-color)}h1,h2,h3,h4,h5,h6{font-family:var(--font-main);color:var(--heading-color)}a{color:var(--link-color);cursor:pointer;text-decoration:none}a:hover{text-decoration:underline}nav a{margin-right:8px}strong,b{color:var(--heading-color)}button{margin:0;cursor:pointer}time{font-family:monospace;font-style:normal;font-size:15px}main{line-height:1.6}table{width:100%}hr{border:0;border-top:1px dashed}img{max-width:100%}code{font-family:monospace;padding:2px;border-radius:3px}blockquote{border-left:1px solid #999;color:var(--blockquote-color);padding-left:20px;font-style:italic}footer{padding:25px 0;text-align:center}.title:hover{text-decoration:none}.title h1{font-size:1.5em}.inline{width:auto !important}.highlight,.code{border-radius:3px;margin-block-start:1em;margin-block-end:1em;overflow-x:auto}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:var(--visited-color)}</style><a href=https://github.com/tomodachi94 rel=me><link rel=webmention href=https://webmention.io/tomodachi94.github.io/webmention><meta name=msvalidate.01 content="71EF19DC0F6663464BD8C4E5919D51C6"></head><body><header><a href=/ class=title><h2>Tomodachi94's Musings</h2></a><nav></nav></header><main><h1>Unit testing with ComputerCraft, McFly, and CraftOS-PC</h1><p><i><time datetime=2025-02-09>09 Feb, 2025</time></i></p><content><p><a href=https://www.howtogeek.com/devops/what-is-unit-testing-and-why-is-it-important/>Unit testing is awesome</a>.
It helps you catch bugs early by ensuring all of the components of your program work as expected.</p><p><strong>Note: This guide is targeted towards <em>experts</em> who have advanced knowledge of ComputerCraft and know a few things about unit tests.</strong>
Experience with unit tests in another language is helpful too, but isn&rsquo;t required.</p><p><a href=https://computercraft.cc>CC: Tweaked</a> contains a little-known unit testing framework called <strong>McFly</strong>, which describes itself as &ldquo;a very basic test framework for ComputerCraft&rdquo; drawing inspiration from the <a href=https://lunarmodules.github.io/busted/>Busted</a> framework for Lua.
This post will function as an introduction to McFly, in the process providing instructions for running the tests inside of the <a href=https://craftos-pc.cc>CraftOS-PC emulator</a>, suitable for running in a continuous integration pipeline.</p><p>This post assumes you have a functional library or program that you want to test, located in a locally-cloned Git repository.
It also assumes that you know how to write and execute shell scripts in Bash.</p><p>This guide assumes you have a library, located at <code>my_library.lua</code>.</p><h2 id=getting-mcfly>Getting McFly</h2><p>McFly is available <a href=https://raw.githubusercontent.com/cc-tweaked/CC-Tweaked/refs/heads/mc-1.20.x/projects/core/src/test/resources/test-rom/mcfly.lua>through the CC: Tweaked GitHub repository</a>.
Download it to a memorable location inside of your repository; we chose <code>test/mcfly.lua</code>.</p><h2 id=getting-craftos-pc>Getting CraftOS-PC</h2><p>This guide assumes that you want to use CraftOS-PC to run the tests outside of the game.</p><p>To install CraftOS-PC, follow the <a href=https://www.craftos-pc.cc/docs/installation>guide on its documentation</a>.
(I&rsquo;m partial to Nix as a maintainer of its package, but I won&rsquo;t judge if you pick another method.)</p><h2 id=make-a-simple-test>Make a simple test</h2><p>Create a simple McFly test at <code>test/addition_spec.lua</code> (the <code>_spec</code> part is important). This will help us know if our setup works. Feel free to delete this file later once you have some tests.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#75715e>-- &#34;addition&#34; is the name of the component you&#39;re testing,</span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- usually a function.</span>
</span></span><span style=display:flex><span>describe(<span style=color:#e6db74>&#34;addition&#34;</span>, <span style=color:#66d9ef>function</span>()
</span></span><span style=display:flex><span>   it(<span style=color:#e6db74>&#34;adds two numbers correctly&#34;</span>, <span style=color:#66d9ef>function</span>()
</span></span><span style=display:flex><span>     expect(<span style=color:#ae81ff>2</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span>):equals(<span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>end</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>)
</span></span></code></pre></div><h2 id=setting-up-the-testing-environment>Setting up the testing environment</h2><p>CraftOS-PC has <a href=https://www.craftos-pc.cc/docs/cli>many CLI options</a>. The ones that interest us are <code>--directory</code>, <code>--headless</code>, and <code>--exec</code>.
The first allows us to override CraftOS-PC&rsquo;s data directory, the second allows us to run CraftOS-PC without opening a GUI, and the third allows us to run arbitrary Lua code.</p><p>Create a new shell script with the following contents. We named it <code>test/test.sh</code>, but feel free to name it something else or integrate it into a preexisting command running solution.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>set -euo pipefail
</span></span><span style=display:flex><span><span style=color:#75715e># This script is CC0; feel free to remove this notice and modify the script however you like, with or without attribution.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Get the root of your Git repository, for copying files into the environment later.</span>
</span></span><span style=display:flex><span>SOURCE_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>git rev-parse --show-toplevel<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Create a temporary directory for storing CraftOS-PC data.</span>
</span></span><span style=display:flex><span>DATA_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>mktemp -d<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>mkdir -p <span style=color:#e6db74>&#34;</span>$DATA_DIR<span style=color:#e6db74>/computer/0&#34;</span>
</span></span><span style=display:flex><span>COMPUTER_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$DATA_DIR<span style=color:#e6db74>/computer/0&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Copy your library into the testing environment.</span>
</span></span><span style=display:flex><span>cp <span style=color:#e6db74>&#34;</span>$SOURCE_DIR<span style=color:#e6db74>/my_library.lua&#34;</span> <span style=color:#e6db74>&#34;</span>$COMPUTER_DIR<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># And your tests!</span>
</span></span><span style=display:flex><span>cp -r <span style=color:#e6db74>&#34;</span>$SOURCE_DIR<span style=color:#e6db74>/test&#34;</span> <span style=color:#e6db74>&#34;</span>$COMPUTER_DIR<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Run CraftOS-PC in headless mode (no GUI) and with the data directory set to $DATA_DIR.</span>
</span></span><span style=display:flex><span>craftos --directory <span style=color:#e6db74>&#34;</span>$DATA_DIR<span style=color:#e6db74>&#34;</span> --exec <span style=color:#e6db74>&#39;shell.run(&#34;test/mcfly.lua test&#34;); os.shutdown()&#39;</span>
</span></span></code></pre></div><p>Make sure to mark it executable with <code>chmod +x ./test/test.sh</code>.</p><p>You should see something like this in your terminal when running <code>test/test.sh</code>:</p><pre tabindex=0><code>$ test/test.sh
Ran 1 test(s), of which 1 passed (100%).
</code></pre><p>Progress! We now have McFly running our tests whenever we run our script.</p><h2 id=writing-our-tests>Writing our tests</h2><p>All that&rsquo;s left to do is write our tests.</p><p>I recommend incrementally writing tests for your code; if you try to write all of your tests all at once, <strong>you will burn out</strong> unless your library is very small.</p><p>Tests come in this general format:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>describe(<span style=color:#e6db74>&#34;identify_sound&#34;</span>, <span style=color:#66d9ef>function</span>()
</span></span><span style=display:flex><span>   it(<span style=color:#e6db74>&#34;can identify meow&#34;</span>, <span style=color:#66d9ef>function</span>()
</span></span><span style=display:flex><span>     <span style=color:#75715e>-- Load your library.</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>local</span> my_library <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#34;my_library&#34;</span>)
</span></span><span style=display:flex><span>     expect(
</span></span><span style=display:flex><span>       <span style=color:#75715e>-- Call your function with its parameters.</span>
</span></span><span style=display:flex><span>       my_library.identify_sound(<span style=color:#e6db74>&#34;meow&#34;</span>)
</span></span><span style=display:flex><span>     <span style=color:#75715e>-- This is what you expect the result to be.</span>
</span></span><span style=display:flex><span>     <span style=color:#75715e>-- McFly has many of these functions; see the documentation in its source code for more.</span>
</span></span><span style=display:flex><span>     ):equals(<span style=color:#e6db74>&#34;cat&#34;</span>)
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>end</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>)
</span></span></code></pre></div><p>McFly expects tests to be named in the format <code>*_spec.lua</code>.</p><p>If you get an error about <code>require</code>, see the next section.</p><h2 id=a-tangent-packagepath-and-require-failing-to-find-your-library>A tangent: <code>package.path</code> and <code>require</code> failing to find your library</h2><p>Don&rsquo;t fret! If your tests fail to find your library, add this one-liner to the top of your test:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>package.path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/?.lua;/?/init.lua;&#34;</span> <span style=color:#f92672>..</span> package.path
</span></span></code></pre></div><p>This one-liner prepends the root (<code>/</code>) directory to <a href=https://www.lua.org/manual/5.1/manual.html#pdf-require><code>package.path</code>, which serves as the search path for <code>require</code></a>.</p><h2 id=running-tests-in-github-actions>Running tests in GitHub Actions</h2><p>This became a little bit tricky, because GitHub Actions&rsquo; Ubuntu runner does not contain a <code>libncurses5</code> library.</p><p>I opted to <a href=https://github.com/unicornpkg/libunicornpkg/blob/cbc4beb8d2542beb016a145e44befa0360320797/.github/workflows/ci.yaml>use Nix when I was setting up testing for libunicornpkg</a>, but not everybody knows Nix so this isn&rsquo;t feasible for most people.</p><p>If you manage to get something non-Nix working on GitHub Actions, please let me know!</p><h2 id=conclusion>Conclusion</h2><p>Thanks for sticking with me through this abnormally large post!</p><p>If something doesn&rsquo;t work, I got something wrong, or I left something important out, please reach out.</p></content><p><a href=https://tomodachi94.github.io/tags/computercraft/>#ComputerCraft</a>
<a href=https://tomodachi94.github.io/tags/mcfly/>#McFly</a>
<a href=https://tomodachi94.github.io/tags/craftos-pc/>#CraftOS-PC</a>
<a href=https://tomodachi94.github.io/tags/unit-testing/>#Unit Testing</a>
<a href=https://tomodachi94.github.io/tags/lua/>#Lua</a>
<a href=https://tomodachi94.github.io/tags/continuous-integration/>#Continuous Integration</a></p></main><footer>Made with <a href=https://github.com/janraasch/hugo-bearblog/>Hugo ʕ•ᴥ•ʔ Bear</a> &bull; &#169; 2025 Tomodachi94 - All Rights Reserved &bull; <a href=https://github.com/tomodachi94/tomodachi94.github.io>Source</a></footer><i></i>
<script data-goatcounter=https://tomodachi94.goatcounter.com/count async src=https://gc.zgo.at/count.js></script><div class=article-content><h2>Comments</h2><p>You can use your Mastodon account to reply to this <a class=link href=https://floss.social/@tomodachi94/113976370639461037>post</a>.</p><p><button id=replyButton href=https://floss.social/@tomodachi94/113976370639461037>Reply</button></p><p id=mastodon-comments-list><button id=load-comment>Load comments</button></p><dialog id=toot-reply class=mastodon data-component=dialog><h3>Reply to tomodachi94's post</h3><p>With an account on the Fediverse or Mastodon, you can respond to this post.
Since Mastodon is decentralized, you can use your existing account hosted by another Mastodon server or compatible platform if you don't have an account on this one.</p><p>Copy and paste this URL into the search field of your favourite Fediverse app or the web interface of your Mastodon server.</p><div class=copypaste><input type=text readonly value=https://floss.social/@tomodachi94/113976370639461037>
<button class=button id=copyButton>Copy</button>
<button class=button id=cancelButton>Close</button></div></dialog><p id=mastodon-comments-list><button id=load-comment>Load comments</button></p><noscript><p>You need JavaScript to view the comments.</p></noscript><script src=/assets/js/purify.min.js></script><script type=text/javascript>const dialog=document.querySelector("dialog");document.getElementById("replyButton").addEventListener("click",()=>{dialog.showModal()}),document.getElementById("copyButton").addEventListener("click",()=>{navigator.clipboard.writeText("https://floss.social/@tomodachi94/113976370639461037")}),document.getElementById("cancelButton").addEventListener("click",()=>{dialog.close()}),dialog.addEventListener("keydown",e=>{e.key==="Escape"&&dialog.close()});const dateOptions={year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric"};function escapeHtml(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}document.getElementById("load-comment").addEventListener("click",function(){document.getElementById("load-comment").innerHTML="Loading",fetch("https://floss.social/api/v1/statuses/113976370639461037/context").then(function(e){return e.json()}).then(function(e){e.descendants&&Array.isArray(e.descendants)&&e.descendants.length>0?(document.getElementById("mastodon-comments-list").innerHTML="",e.descendants.forEach(function(e){e.account.display_name=escapeHtml(e.account.display_name),e.account.reply_class=e.in_reply_to_id=="113976370639461037"?"reply-original":"reply-child",e.created_date=new Date(e.created_at),e.account.emojis.forEach(t=>{e.account.display_name=e.account.display_name.replace(`:${t.shortcode}:`,`<img src="${escapeHtml(t.static_url)}" alt="Emoji ${t.shortcode}" height="20" width="20" />`)}),mastodonComment=`
<div class="mastodon-wrapper">
  <div class="comment-level ${e.account.reply_class}"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
    <path fill="currentColor" stroke="currentColor" d="m 307,477.17986 c -11.5,-5.1 -19,-16.6 -19,-29.2 v -64 H 176 C 78.8,383.97986 -4.6936293e-8,305.17986 -4.6936293e-8,207.97986 -4.6936293e-8,94.679854 81.5,44.079854 100.2,33.879854 c 2.5,-1.4 5.3,-1.9 8.1,-1.9 10.9,0 19.7,8.9 19.7,19.7 0,7.5 -4.3,14.4 -9.8,19.5 -9.4,8.8 -22.2,26.4 -22.2,56.700006 0,53 43,96 96,96 h 96 v -64 c 0,-12.6 7.4,-24.1 19,-29.2 11.6,-5.1 25,-3 34.4,5.4 l 160,144 c 6.7,6.2 10.6,14.8 10.6,23.9 0,9.1 -3.9,17.7 -10.6,23.8 l -160,144 c -9.4,8.5 -22.9,10.6 -34.4,5.4 z" />
  </svg></div>
  <div class="mastodon-comment">
    <div class="comment">
      <div class="comment-avatar"><img src="${escapeHtml(e.account.avatar_static)}" alt=""></div>
      <div class="comment-author">
        <div class="comment-author-name"><a href="${e.account.url}" rel="nofollow">${e.account.display_name}</a></div>
        <div class="comment-author-reply"><a href="${e.account.url}" rel="nofollow">${escapeHtml(e.account.acct)}</a></div>
      </div>
      <div class="comment-author-date">${e.created_date.toLocaleString(navigator.language,dateOptions)}</div>
    </div>
    <div class="comment-content">${e.content}</div> 
  </div>
</div>
`,document.getElementById("mastodon-comments-list").appendChild(DOMPurify.sanitize(mastodonComment,{RETURN_DOM_FRAGMENT:!0}))})):document.getElementById("mastodon-comments-list").innerHTML="<p>No comments found</p>"})})</script></div></body></html>